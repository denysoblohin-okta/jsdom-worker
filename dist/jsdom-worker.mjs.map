{"version":3,"file":"jsdom-worker.mjs","sources":["../node_modules/mitt/dist/mitt.mjs","../node_modules/uuid-v4/index.js","../src/index.js"],"sourcesContent":["export default function(n){return{all:n=n||new Map,on:function(t,e){var i=n.get(t);i?i.push(e):n.set(t,[e])},off:function(t,e){var i=n.get(t);i&&(e?i.splice(i.indexOf(e)>>>0,1):n.set(t,[]))},emit:function(t,e){var i=n.get(t);i&&i.slice().map(function(n){n(e)}),(i=n.get(\"*\"))&&i.slice().map(function(n){n(t,e)})}}}\n//# sourceMappingURL=mitt.mjs.map\n","\nexports = module.exports = function() {\n\tvar ret = '', value;\n\tfor (var i = 0; i < 32; i++) {\n\t\tvalue = exports.random() * 16 | 0;\n\t\t// Insert the hypens\n\t\tif (i > 4 && i < 21 && ! (i % 4)) {\n\t\t\tret += '-';\n\t\t}\n\t\t// Add the next random character\n\t\tret += (\n\t\t\t(i === 12) ? 4 : (\n\t\t\t\t(i === 16) ? (value & 3 | 8) : value\n\t\t\t)\n\t\t).toString(16);\n\t}\n\treturn ret;\n};\n\nvar uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/;\nexports.isUUID = function(uuid) {\n\treturn uuidRegex.test(uuid);\n};\n\nexports.random = function() {\n\treturn Math.random();\n};\n\n","import mitt from 'mitt';\nimport uuid from 'uuid-v4';\nimport fetch, { Response } from 'node-fetch';\n\n// eslint-disable-next-line no-undef\n\nconst self = /** @type {globalThis} */ (\n\ttypeof global === 'object'\n\t\t? global\n\t\t: typeof globalThis === 'object'\n\t\t? globalThis\n\t\t: this\n);\n\n// @ts-ignore-next-line\nif (!self.URL) self.URL = {};\n\n// @ts-ignore\nlet objects = /** @type {Map<any, string>} */ (self.URL.$$objects);\n\nif (!objects) {\n\tobjects = new Map();\n\t// @ts-ignore\n\tself.URL.$$objects = objects;\n\tself.URL.createObjectURL = blob => {\n\t\tlet id = uuid();\n\t\tobjects[id] = blob;\n\t\treturn `blob:http://localhost/${id}`;\n\t};\n\tself.URL.revokeObjectURL = (url) => {\n\t\tlet m = String(url).match(/^blob:http:\\/\\/localhost\\/(.+)$/);\n\t\tif (m) delete objects[m[1]];\n\t};\n\n\tconst OrigBlob = Blob;\n\tself.Blob = function(arr, opts) {\n\t\t\tconst blob = new OrigBlob(arr, opts);\n\t\t\tblob._arr = arr;\n\t\t\treturn blob;\n\t};\n}\n\nif (!self.fetch || !('jsdomWorker' in self.fetch)) {\n\tlet oldFetch = self.fetch || fetch;\n\tself.fetch = function (url, opts) {\n\t\tlet _url = typeof url === 'object' ? url.url || url.href : url;\n\t\tif (_url.match(/^blob:/)) {\n\t\t\tconst id = _url.match(/[^/]+$/)[0];\n\t\t\tconst blob = objects[id];\n\t\t\tif (blob._arr) {\n\t\t\t\treturn blob._arr[0];\n\t\t\t}\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tlet fr = new FileReader();\n\t\t\t\tfr.onload = () => {\n\t\t\t\t\tlet Res = self.Response || Response;\n\t\t\t\t\tresolve(new Res(fr.result, { status: 200, statusText: 'OK' }));\n\t\t\t\t};\n\t\t\t\tfr.onerror = () => {\n\t\t\t\t\treject(fr.error);\n\t\t\t\t};\n\t\t\t\tfr.readAsText(blob);\n\t\t\t});\n\t\t}\n\t\treturn oldFetch.call(this, url, opts);\n\t};\n\tObject.defineProperty(self.fetch, 'jsdomWorker', {\n\t\tconfigurable: true,\n\t\tvalue: true,\n\t});\n}\n\n// @ts-ignore\nif (!self.document) self.document = {};\n\nfunction Event(type) {\n\tthis.type = type;\n}\nEvent.prototype.initEvent = Object;\nif (!self.document.createEvent) {\n\tself.document.createEvent = function (type) {\n\t\tlet Ctor = global[type] || Event;\n\t\treturn new Ctor(type);\n\t};\n}\n\n// @ts-ignore\nself.Worker = Worker;\n\n/**\n * @param {string | URL} url\n * @param {object} [options = {}]\n */\nfunction Worker(url, options) {\n\tlet getScopeVar;\n\t/** @type {any[] | null} */\n\tlet messageQueue = [];\n\tlet inside = mitt();\n\tlet outside = mitt();\n\tlet terminated = false;\n\tlet scope = {\n\t\tonmessage: null,\n\t\tdispatchEvent: inside.emit,\n\t\taddEventListener: inside.on,\n\t\tremoveEventListener: inside.off,\n\t\tpostMessage(data) {\n\t\t\toutside.emit('message', { data });\n\t\t},\n\t\tfetch: self.fetch,\n\t\timportScripts() {},\n\t};\n\tinside.on('message', e => {\n\t\tif (terminated) return;\n\t\tlet f = scope.onmessage || getScopeVar('onmessage');\n\t\tif (f) f.call(scope, e);\n\t});\n\tthis.addEventListener = outside.on;\n\tthis.removeEventListener = outside.off;\n\tthis.dispatchEvent = outside.emit;\n\toutside.on('message', e => {\n\t\tif (this.onmessage) this.onmessage(e);\n\t});\n\tthis.onmessage = null;\n\tthis.postMessage = data => {\n\t\tif (terminated) return;\n\t\tif (messageQueue != null) messageQueue.push(data);\n\t\telse inside.emit('message', { data });\n\t};\n\tthis.terminate = () => {\n\t\tconsole.warn('Worker.prototype.terminate() not supported in jsdom-worker.');\n\t\tterminated = true;\n\t\tmessageQueue = null;\n\t};\n\tconst runCode = (code) => {\n\t\tlet vars = 'var self=this,global=self';\n\t\tfor (let k in scope) vars += `,${k}=self.${k}`;\n\t\tgetScopeVar = Function(\n\t\t\tvars +\n\t\t\t\t';\\n' +\n\t\t\t\tcode +\n\t\t\t\t'\\nreturn function(n){return n==\"onmessage\"?onmessage:null;}'\n\t\t).call(scope);\n\t\tlet q = messageQueue;\n\t\tmessageQueue = null;\n\t\tif (q) q.forEach(this.postMessage);\n\t};\n\tconst fetchRes = self.fetch(url);\n\tif (typeof fetchRes === 'string') {\n\t\trunCode(fetchRes);\n\t} else {\n\t\tfetchRes\n\t\t\t.then(r => r.text())\n\t\t\t.then(code => {\n\t\t\t\trunCode(code);\n\t\t\t})\n\t\t\t.catch(e => {\n\t\t\t\toutside.emit('error', e);\n\t\t\t\tconsole.error(e);\n\t\t\t});\n\t}\n}\n"],"names":["mitt","n","all","Map","on","t","e","i","get","push","set","off","splice","indexOf","emit","slice","map","exports","module","value","ret","random","toString","uuidRegex","isUUID","uuid","test","Math","self","global","globalThis","this","URL","$$objects","objects","createObjectURL","blob","id","revokeObjectURL","url","m","String","match","OrigBlob","Blob","arr","opts","_arr","fetch","href","_url","resolve","reject","fr","FileReader","onload","Response","result","status","statusText","onerror","error","readAsText","oldFetch","call","Object","defineProperty","configurable","Event","type","document","prototype","initEvent","createEvent","Worker","options","inside","outside","terminated","onmessage","dispatchEvent","addEventListener","removeEventListener","postMessage","data","importScripts","f","scope","getScopeVar","messageQueue","terminate","console","warn","runCode","code","vars","k","Function","q","forEach","fetchRes","then","r","text","catch"],"mappings":"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"}